<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de Tareas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="estilo.css" />
</head>
<body>
  <header class="header">
    <h1 class="header__title">Lista de Tareas</h1>
    <nav class="header__actions">
      <a class="btn btn--primary" href="a√±adir.html">A√±adir tarea</a>
      <a class="btn" href="eliminar.html">Eliminar tarea</a>
    </nav>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <h2 class="sidebar__title">Filtros</h2>

      <label for="filtro-categoria" class="label">Categor√≠a</label>
      <input id="filtro-categoria" class="input" list="categorias" placeholder="Todas / escrib√≠ para filtrar" oninput="mostrarTareas()" />
      <datalist id="categorias">
        <option value="Todas"></option>
        <option value="Trabajo"></option>
        <option value="Estudio"></option>
        <option value="Personal"></option>
      </datalist>

      <label for="orden" class="label" style="margin-top:8px;">Ordenar por</label>
      <select id="orden" class="select" onchange="mostrarTareas()">
        <option value="creacion_desc">M√°s nuevas</option>
        <option value="creacion_asc">M√°s antiguas</option>
        <option value="nombre_asc">Nombre (A‚ÄìZ)</option>
        <option value="nombre_desc">Nombre (Z‚ÄìA)</option>
        <option value="vencimiento_asc">Vence antes</option>
        <option value="vencimiento_desc">Vence despu√©s</option>
      </select>
      <small class="hint">Las tareas ancladas siempre van primero.</small>
    </aside>

    <main class="main">
      <h2 class="main__title">Tareas</h2>
      <div id="lista-tareas" class="lista"></div>
    </main>
  </div>

  <script>
    // -------- utilidades de storage ----------
    function getTareas() {
      return JSON.parse(localStorage.getItem('tareas')) || [];
    }
    function setTareas(t) {
      localStorage.setItem('tareas', JSON.stringify(t));
    }
    // Genera un id simple y √∫nico (suficiente para este caso)
    function newId() {
      return 't_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    }
    function ensureId(t) {
      if (t.id) return t.id;
      t.id = 'm_' + (t.creadaEn ?? Date.now()); // usa creadaEn como base si existe
      return t.id;
    }
    function findIndexById(arr, id) {
      return arr.findIndex(t => (t.id || t.creadaEn) === id);
    }

    // -------- colores por categor√≠a (din√°micos y estables) ----------
    function hashHue(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) % 360;
      return h;
    }
    function styleForCategory(cat) {
      const base = (cat && cat.trim()) ? cat.trim() : 'Sin categor√≠a';
      const hue = hashHue(base.toLowerCase());
      const bg = `hsl(${hue} 70% 92%)`;
      const text = `hsl(${hue} 30% 28%)`;
      const border = `hsl(${hue} 45% 82%)`;
      return { bg, text, border, label: base };
    }

    // -------- ordenar (ancladas primero) ----------
    function ordenarTareas(tareas, criterio) {
      const copia = [...tareas];
      // ancladas primero
      copia.sort((a, b) => (b.fijada?1:0) - (a.fijada?1:0));
      const compare = (a,b) => {
        switch (criterio) {
          case 'creacion_asc': return (a.creadaEn||0) - (b.creadaEn||0);
          case 'creacion_desc': return (b.creadaEn||0) - (a.creadaEn||0);
          case 'nombre_asc': return (a.nombre||'').localeCompare(b.nombre||'');
          case 'nombre_desc': return (b.nombre||'').localeCompare(a.nombre||'');
          case 'vencimiento_asc': return (a.vencimiento||'').localeCompare(b.vencimiento||'');
          case 'vencimiento_desc': return (b.vencimiento||'').localeCompare(a.vencimiento||'');
          default: return 0;
        }
      };
      let i = 0;
      while (i < copia.length) {
        const flag = !!copia[i].fijada;
        let j = i;
        while (j < copia.length && !!copia[j].fijada === flag) j++;
        copia.splice(i, j - i, ...copia.slice(i, j).sort(compare));
        i = j;
      }
      return copia;
    }

    function mostrarTareas() {
      const contenedor = document.getElementById('lista-tareas');
      contenedor.innerHTML = '';

      const filtroInput = document.getElementById('filtro-categoria').value.trim();
      const filtro = (filtroInput === '' || filtroInput.toLowerCase() === 'todas') ? 'Todas' : filtroInput;
      const criterio = document.getElementById('orden').value;

      let tareas = getTareas();
      if (tareas.length === 0) {
        contenedor.innerHTML = '<p class="vacio">No hay tareas. Us√° ‚ÄúA√±adir tarea‚Äù.</p>';
        return;
      }

      tareas.forEach(t => ensureId(t));
      setTareas(tareas);

      tareas = ordenarTareas(tareas, criterio);

      tareas.forEach((tarea) => {
        if (filtro !== 'Todas' && (tarea.categoria || 'Sin categor√≠a') !== filtro) return;

        const id = tarea.id || tarea.creadaEn; // clave estable
        const tarjeta = document.createElement('div');
        tarjeta.className = 'tarjeta' + (tarea.realizada ? ' realizada' : '') + (tarea.fijada ? ' tarjeta--pinned' : '');
        tarjeta.dataset.id = id;

        const info = document.createElement('div');
        info.className = 'tarjeta__info';

        const headerRow = document.createElement('div');
        headerRow.className = 'tarjeta__row';

        // Bot√≥n estado (realizada)
        const statusBtn = document.createElement('button');
        statusBtn.className = 'status' + (tarea.realizada ? ' is-done' : '');
        statusBtn.title = tarea.realizada ? 'Marcar como pendiente' : 'Marcar como realizada';
        statusBtn.setAttribute('aria-pressed', tarea.realizada ? 'true' : 'false');
        statusBtn.onclick = function () { toggleDoneById(id); };

        const nombre = document.createElement('strong');
        nombre.textContent = tarea.nombre || 'Sin nombre';
        nombre.className = 'tarjeta__nombre';

        headerRow.appendChild(statusBtn);
        headerRow.appendChild(nombre);

        const desc = document.createElement('p');
        desc.className = 'tarjeta__desc';
        desc.textContent = tarea.descripcion || '';

        const tag = document.createElement('small');
        const cat = (tarea.categoria || 'Sin categor√≠a');
        const style = styleForCategory(cat);
        tag.className = 'tag';
        tag.textContent = style.label;
        tag.style.background = style.bg;
        tag.style.color = style.text;
        tag.style.borderColor = style.border;

        const metasWrap = document.createElement('div');
        metasWrap.style.marginTop = '4px';

        const fechas = document.createElement('small');
        const partes = [];
        if (tarea.vencimiento) partes.push('Vence: ' + tarea.vencimiento);
        if (tarea.creadaEn) {
          const d = new Date(tarea.creadaEn);
          partes.push('Creada: ' + d.toLocaleDateString());
        }
        fechas.textContent = partes.join(' ¬∑ ');

        info.appendChild(headerRow);
        if (tarea.descripcion) info.appendChild(desc);
        info.appendChild(tag);
        if (partes.length) metasWrap.appendChild(fechas);
        if (metasWrap.childNodes.length) info.appendChild(metasWrap);

        const acciones = document.createElement('div');
        acciones.className = 'tarjeta__acciones';

        const btnPin = document.createElement('button');
        btnPin.className = 'btn btn--small btn--icon';
        btnPin.title = tarea.fijada ? 'Quitar anclaje' : 'Anclar';
        btnPin.textContent = tarea.fijada ? 'üìå' : 'üìç';
        btnPin.onclick = function () { togglePinById(id); };

        const btnEditar = document.createElement('button');
        btnEditar.className = 'btn btn--small';
        btnEditar.textContent = 'Editar';
        btnEditar.onclick = function () { editarTareaById(id); };

        acciones.appendChild(btnPin);
        acciones.appendChild(btnEditar);

        tarjeta.appendChild(info);
        tarjeta.appendChild(acciones);
        contenedor.appendChild(tarjeta);
      });
    }

    // -------- acciones por ID ----------
    function toggleDoneById(id) {
      const tareas = getTareas();
      const idx = findIndexById(tareas, id);
      if (idx === -1) return;
      tareas[idx].realizada = !tareas[idx].realizada;
      setTareas(tareas);
      mostrarTareas();
    }

    function togglePinById(id) {
      const tareas = getTareas();
      const idx = findIndexById(tareas, id);
      if (idx === -1) return;
      tareas[idx].fijada = !tareas[idx].fijada;
      setTareas(tareas);
      mostrarTareas();
    }

    function editarTareaById(id) {
      const tareas = getTareas();
      const idx = findIndexById(tareas, id);
      if (idx === -1) return;
      const actual = tareas[idx];

      const nuevoNombre = prompt('Nuevo nombre:', actual.nombre ?? '');
      if (nuevoNombre === null) return;
      const nombreFinal = (nuevoNombre || '').trim();
      if (!nombreFinal) { alert('El nombre no puede quedar vac√≠o.'); return; }

      const nuevaDescripcion = prompt('Nueva descripci√≥n:', actual.descripcion ?? '');
      if (nuevaDescripcion === null) return;

      const nuevaCategoria = prompt('Nueva categor√≠a (escrib√≠ cualquier nombre):', actual.categoria ?? '');
      if (nuevaCategoria === null) return;
      const catFinal = (nuevaCategoria || '').trim() || 'Sin categor√≠a';

      const nuevaVenc = prompt('Nueva fecha de vencimiento (AAAA-MM-DD, opcional):', actual.vencimiento ?? '');
      if (nuevaVenc === null) return;
      const vencFinal = (nuevaVenc || '').trim();

      const fijadaStr = prompt('¬øFijar tarea? (si/no)', actual.fijada ? 'si' : 'no');
      if (fijadaStr === null) return;
      const fijada = /^s[i√≠]$/i.test((fijadaStr || '').trim());

      actual.id = ensureId(actual);
      actual.nombre = nombreFinal;
      actual.descripcion = (nuevaDescripcion || '').trim();
      actual.categoria = catFinal;
      actual.vencimiento = vencFinal;
      actual.fijada = fijada;

      setTareas(tareas);
      mostrarTareas();
    }

    window.onload = mostrarTareas;
  </script>
</body>
</html>

